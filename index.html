<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DevTask - Secure & Sync</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        /* --- THEME: NORD --- */
        :root { --bg-body: #2e3440; --bg-card: #3b4252; --bg-input: #434c5e; --text-main: #d8dee9; --text-muted: #94a3b8; --accent-primary: #88c0d0; --accent-secondary: #ebcb8b; --accent-danger: #bf616a; --accent-success: #a3be8c; --border-radius: 8px; --border-color: #4c566a; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        body { background-color: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; justify-content: center; align-items: center; padding: 2rem; overflow: hidden; }
        
        /* LOGIN OVERLAY */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(46, 52, 64, 0.95); backdrop-filter: blur(10px); z-index: 9999; display: flex; justify-content: center; align-items: center; padding: 20px; animation: fadeIn 0.3s ease; }
        .login-box { background: var(--bg-card); border: 1px solid var(--accent-primary); padding: 40px; width: 100%; max-width: 400px; border-radius: 12px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-title { font-size: 1.5rem; font-weight: 700; margin-bottom: 10px; color: var(--accent-primary); }
        .login-sub { color: var(--text-muted); font-size: 0.9rem; margin-bottom: 25px; }

        /* APP LAYOUT */
        .app-container { display: grid; grid-template-columns: 320px 1fr; gap: 30px; width: 100%; max-width: 1100px; height: 85vh; opacity: 0; transition: opacity 0.5s ease; }
        @media (max-width: 900px) {
            .app-container { grid-template-columns: 1fr; height: 100%; display: flex; flex-direction: column; overflow-y: auto; padding-bottom: 20px; }
            body { height: auto; overflow: auto; padding: 10px; }
            .quick-box, .scheduled-box { flex: none !important; height: 300px !important; }
            .dev-footer { margin-top: 20px; padding-bottom: 20px; }
        }

        .dev-card { background: var(--bg-card); border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .sidebar { display: flex; flex-direction: column; flex-shrink: 0; }
        
        /* USER SECTION & LOGOUT */
        .user-section { margin-bottom: 35px; }
        .greeting-row { display: flex; align-items: center; justify-content: space-between; gap: 6px; font-size: 1.2rem; }
        .user-name { font-weight: 700; color: white; border-bottom: 1px dashed transparent; }
        
        /* Logout Button Style */
        .logout-btn {
            background: rgba(191, 97, 106, 0.1); 
            color: var(--accent-danger);
            border: 1px solid transparent;
            border-radius: 6px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .logout-btn:hover { background: var(--accent-danger); color: white; transform: scale(1.05); }

        .welcome-sub { font-size: 0.9rem; color: var(--text-muted); margin-top: 4px; }
        
        .toggle-group { display: flex; gap: 10px; margin-bottom: 25px; }
        .type-btn { flex: 1; padding: 10px; background: transparent; border: 2px solid var(--border-color); color: var(--text-muted); border-radius: var(--border-radius); cursor: pointer; font-weight: 500; transition: 0.2s; }
        .type-btn.active { border-color: var(--accent-primary); color: var(--accent-primary); background: rgba(136, 192, 208, 0.1); }
        .type-btn#btnQuick.active { border-color: var(--accent-secondary); color: var(--accent-secondary); background: rgba(235, 203, 139, 0.1); }
        
        .input-group { margin-bottom: 15px; text-align: left; }
        label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }
        input, select { width: 100%; background: var(--bg-input); border: 1px solid transparent; color: white; padding: 12px; border-radius: 6px; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--accent-primary); background: #4c566a; }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        .add-btn { margin-top: 10px; width: 100%; padding: 14px; background: var(--accent-primary); color: #2e3440; font-weight: 700; border: none; border-radius: var(--border-radius); cursor: pointer; transition: 0.2s; }
        #scheduledInputs { display: none; }

        .main-content { display: flex; flex-direction: column; gap: 20px; height: 100%; overflow: hidden; min-height: 0; }
        .box-header { display: flex; justify-content: space-between; align-items: center; padding-bottom: 15px; border-bottom: 2px solid var(--bg-body); margin-bottom: 10px; flex-shrink: 0; }
        .box-title { font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .clear-btn { background: transparent; border: none; color: var(--accent-danger); font-size: 0.8rem; cursor: pointer; opacity: 0.6; }
        .clear-btn:hover { opacity: 1; }
        .task-list { overflow-y: auto; padding-right: 5px; flex-grow: 1; min-height: 0; }
        .task-list::-webkit-scrollbar { width: 5px; }
        .task-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
        .quick-box { display: flex; flex-direction: column; border-top: 3px solid var(--accent-secondary); height: 35%; min-height: 200px; }
        .scheduled-box { display: flex; flex-direction: column; border-top: 3px solid var(--accent-primary); flex-grow: 1; min-height: 0; }
        
        .task-item { background: var(--bg-input); margin-bottom: 8px; padding: 12px 16px; border-radius: 6px; display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .task-item.completed { opacity: 0.5; text-decoration: line-through; }
        .check-box { width: 20px; height: 20px; border: 2px solid var(--text-muted); border-radius: 4px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
        .task-content { flex: 1; }
        .task-meta { display: flex; gap: 10px; margin-top: 4px; font-family: 'JetBrains Mono', monospace; font-size: 0.7rem; }
        .meta-High { color: var(--accent-danger); } .meta-Medium { color: var(--accent-secondary); } .meta-Low { color: var(--accent-success); }
        .delete-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 5px; }
        .delete-btn:hover { color: var(--accent-danger); }
        .date-sep { font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; color: var(--accent-primary); margin: 15px 0 8px; opacity: 0.8; flex-shrink: 0; }
        .dev-footer { text-align: center; font-size: 0.75rem; color: var(--text-muted); font-family: 'JetBrains Mono', monospace; margin-top: auto; opacity: 0.6; letter-spacing: 0.5px; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="loginOverlay" class="login-overlay">
        <div class="login-box">
            <div class="login-title">Secure Access</div>
            <div class="login-sub">Enter your codename & password</div>
            <div class="input-group">
                <input type="text" id="loginNameInput" placeholder="> Codename" autocomplete="off">
            </div>
            <div class="input-group">
                <input type="password" id="loginPassInput" placeholder="> Password" autocomplete="off">
            </div>
            <button class="add-btn" id="loginBtn">Login / Register</button>
            <div style="font-size:0.7rem; color:#94a3b8; margin-top:10px;">
                (New user? Enter a password to register instantly)
            </div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <aside class="dev-card sidebar">
            <div class="user-section">
                <div class="greeting-row">
                    <div style="display:flex; align-items:center; gap:6px;">
                        <span>Hello,</span>
                        <span id="userName" class="user-name">Dev</span>
                    </div>
                    <button id="logoutBtn" class="logout-btn" title="Sign Out">
                        <i class="ph-bold ph-power"></i>
                    </button>
                </div>
                <div class="welcome-sub">welcome back.</div>
            </div>
            <div class="toggle-group">
                <button class="type-btn active" id="btnQuick">Quick</button>
                <button class="type-btn" id="btnSched">Scheduled</button>
            </div>
            <div class="input-group">
                <label>TASK DESCRIPTION</label>
                <input type="text" id="taskInput" placeholder="> Type here..." autocomplete="off">
            </div>
            <div id="scheduledInputs">
                <div class="input-group">
                    <label>TARGET DATE</label>
                    <input type="date" id="dateInput">
                </div>
                <div class="input-group">
                    <label>PRIORITY</label>
                    <select id="priorityInput">
                        <option value="High">High (Urgent)</option>
                        <option value="Medium" selected>Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
            </div>
            <button class="add-btn" id="commitBtn">COMMIT TASK</button>
        </aside>

        <main class="main-content">
            <div class="dev-card quick-box">
                <div class="box-header">
                    <div class="box-title" style="color: var(--accent-secondary)">
                        <i class="ph-fill ph-lightning"></i> Quick Notes
                    </div>
                    <button class="clear-btn" id="clearQuick">Clear All</button>
                </div>
                <div id="quickList" class="task-list"></div>
            </div>
            <div class="dev-card scheduled-box">
                <div class="box-header">
                    <div class="box-title" style="color: var(--accent-primary)">
                        <i class="ph-fill ph-calendar-check"></i> Scheduled Plan
                    </div>
                    <button class="clear-btn" id="clearSched">Clear All</button>
                </div>
                <div id="scheduledList" class="task-list"></div>
            </div>
            <div class="dev-footer">&copy; Developed by Promis Vora</div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update, get, set, child } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDJiG6SkXmj_ofDuYiIRf8D5H6kyNvuhho",
            authDomain: "to-do-promise.firebaseapp.com",
            projectId: "to-do-promise",
            storageBucket: "to-do-promise.firebasestorage.app",
            messagingSenderId: "1033945661048",
            appId: "1:1033945661048:web:859e70fe1788ccd989b78d",
            measurementId: "G-EPWPC7CQNW",
            databaseURL: "https://to-do-promise-default-rtdb.firebaseio.com"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Variables
        let tasksRef;
        let tasks = [];
        let mode = 'quick';
        let currentUser = '';
        const STORAGE_KEY_USER = 'devTask_user_secure';

        // --- 1. SETUP FIREBASE FOR SPECIFIC USER ---
        function initFirebaseForUser(userName) {
            currentUser = userName;
            tasksRef = ref(db, 'tasks/' + userName);

            onValue(tasksRef, (snapshot) => {
                tasks = [];
                const data = snapshot.val();
                if(data) {
                    Object.keys(data).forEach(key => {
                        tasks.push({ id: key, ...data[key] });
                    });
                }
                render();
            });
        }

        // --- 2. LOGOUT FUNCTION ---
        function logout() {
            if(confirm("Are you sure you want to sign out?")) {
                localStorage.removeItem(STORAGE_KEY_USER); // Clear storage
                location.reload(); // Refresh page to show login screen
            }
        }

        // --- 3. LOGIN LOGIC ---
        async function submitLogin() {
            const rawName = document.getElementById('loginNameInput').value.trim();
            const password = document.getElementById('loginPassInput').value.trim();
            const name = rawName.replace(/[^a-zA-Z0-9]/g, ""); 

            if(!name || !password) return alert("Username and Password are required!");

            const loginBtn = document.getElementById('loginBtn');
            loginBtn.innerText = "Checking...";
            const dbRef = ref(db);
            
            try {
                const snapshot = await get(child(dbRef, `credentials/${name}`));
                
                if (snapshot.exists()) {
                    if (snapshot.val() === password) {
                        loginSuccess(name);
                    } else {
                        alert("❌ INCORRECT PASSWORD!");
                        loginBtn.innerText = "Login / Register";
                    }
                } else {
                    if(confirm(`Create new account '${name}' with this password?`)) {
                        await set(ref(db, 'credentials/' + name), password);
                        alert("✅ Account Created!");
                        loginSuccess(name);
                    } else {
                        loginBtn.innerText = "Login / Register";
                    }
                }
            } catch (error) {
                console.error(error);
                alert("Connection Error.");
                loginBtn.innerText = "Login / Register";
            }
        }

        function loginSuccess(name) {
            localStorage.setItem(STORAGE_KEY_USER, name);
            document.getElementById('userName').innerText = name;
            const overlay = document.getElementById('loginOverlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                document.getElementById('appContainer').style.opacity = '1';
            }, 300);
            initFirebaseForUser(name);
        }

        function checkAutoLogin() {
            const savedUser = localStorage.getItem(STORAGE_KEY_USER);
            if (savedUser) {
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('appContainer').style.opacity = '1';
                document.getElementById('userName').innerText = savedUser;
                initFirebaseForUser(savedUser);
            } else {
                document.getElementById('loginNameInput').focus();
            }
        }

        // --- 4. TASK OPERATIONS ---
        function addTask() {
            if(!currentUser) return;
            const text = document.getElementById('taskInput').value.trim();
            if(!text) return;
            
            const newTask = {
                text: text, type: mode, completed: false, timestamp: Date.now()
            };

            if(mode === 'scheduled') {
                const date = document.getElementById('dateInput').value;
                if(!date) return alert("Date required");
                newTask.date = date;
                newTask.priority = document.getElementById('priorityInput').value;
            }
            push(tasksRef, newTask);
            document.getElementById('taskInput').value = '';
        }

        window.toggleTask = (id, currentStatus) => update(ref(db, `tasks/${currentUser}/${id}`), { completed: !currentStatus });
        window.removeTask = (id) => remove(ref(db, `tasks/${currentUser}/${id}`));
        window.clearGroup = (type) => {
            if(confirm(`Delete all ${type} tasks?`)) {
                tasks.filter(t => t.type === type).forEach(t => remove(ref(db, `tasks/${currentUser}/${t.id}`)));
            }
        }

        // --- 5. RENDER ---
        function toggleMode(newMode) {
            mode = newMode;
            document.getElementById('btnQuick').classList.toggle('active', mode === 'quick');
            document.getElementById('btnSched').classList.toggle('active', mode === 'scheduled');
            document.getElementById('scheduledInputs').style.display = mode === 'quick' ? 'none' : 'block';
            document.getElementById('taskInput').placeholder = mode === 'quick' ? "> Quick note..." : "> Scheduled task...";
        }

        function render() {
            const qList = document.getElementById('quickList');
            const sList = document.getElementById('scheduledList');
            qList.innerHTML = ''; sList.innerHTML = '';
            
            const quicks = tasks.filter(t => t.type === 'quick');
            const scheds = tasks.filter(t => t.type === 'scheduled');

            if(!quicks.length) qList.innerHTML = `<div style="color:#4c566a; text-align:center; padding:10px;">// No quick notes</div>`;
            quicks.forEach(t => qList.innerHTML += createHTML(t));

            if(!scheds.length) sList.innerHTML = `<div style="color:#4c566a; text-align:center; padding:10px;">// No scheduled tasks</div>`;
            scheds.sort((a,b) => new Date(a.date) - new Date(b.date) || (a.priority===b.priority?0:a.priority==='High'?-1:1));
            
            let lastDate = '';
            scheds.forEach(t => {
                if(t.date !== lastDate) {
                    const d = new Date(t.date).toLocaleDateString('en-GB', {day:'numeric', month:'short', year:'numeric'});
                    sList.innerHTML += `<div class="date-sep"># ${d}</div>`;
                    lastDate = t.date;
                }
                sList.innerHTML += createHTML(t);
            });
        }

        function createHTML(t) {
            return `
                <div class="task-item ${t.completed ? 'completed' : ''}">
                    <div class="check-box" onclick="toggleTask('${t.id}', ${t.completed})">
                        ${t.completed ? '<i class="ph-bold ph-check"></i>' : ''}
                    </div>
                    <div class="task-content">
                        <div class="task-text">${t.text}</div>
                        ${t.type === 'scheduled' ? `<div class="task-meta"><span class="meta-${t.priority}">[${t.priority}]</span></div>` : ''}
                    </div>
                    <button class="delete-btn" onclick="removeTask('${t.id}')"><i class="ph-bold ph-trash"></i></button>
                </div>
            `;
        }

        // --- 6. EVENT LISTENERS ---
        document.getElementById('btnQuick').addEventListener('click', () => toggleMode('quick'));
        document.getElementById('btnSched').addEventListener('click', () => toggleMode('scheduled'));
        document.getElementById('commitBtn').addEventListener('click', addTask);
        document.getElementById('taskInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') addTask(); });
        document.getElementById('clearQuick').addEventListener('click', () => clearGroup('quick'));
        document.getElementById('clearSched').addEventListener('click', () => clearGroup('scheduled'));
        document.getElementById('logoutBtn').addEventListener('click', logout); // NEW LOGOUT LISTENER

        const loginBtn = document.getElementById('loginBtn');
        const loginInput = document.getElementById('loginNameInput');
        const passInput = document.getElementById('loginPassInput');
        
        loginBtn.addEventListener('click', submitLogin);
        passInput.addEventListener('keypress', (e) => { if(e.key==='Enter') submitLogin() });

        document.getElementById('dateInput').valueAsDate = new Date();
        checkAutoLogin();

    </script>
</body>
</html>